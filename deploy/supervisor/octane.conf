# ============================================
# Laravel Octane Supervisor Configuration
# Optimized for Production
# ============================================

[program:octane]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/nextmedya/artisan octane:start --server=swoole --host=127.0.0.1 --port=8000
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/log/octane.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=30
startsecs=5
startretries=3

# Graceful shutdown for Octane
stopsignal=SIGTERM

# Restart if memory usage exceeds 512MB
# This prevents memory leaks from accumulating
stopasgroup=true
killasgroup=true

# Priority (lower number = higher priority)
priority=10

# ============================================
# Laravel Queue Workers
# Using Redis for better performance
# ============================================

[program:queue-default]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/nextmedya/artisan queue:work redis --queue=default --sleep=3 --tries=3 --max-time=3600 --memory=256
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/log/queue-default.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=3600
startsecs=1
startretries=3
stopsignal=SIGTERM
priority=20

# ============================================
# High Priority Queue Worker (emails, notifications)
# ============================================

[program:queue-high]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/nextmedya/artisan queue:work redis --queue=high,default --sleep=1 --tries=3 --max-time=1800 --memory=128
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/log/queue-high.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=1800
startsecs=1
startretries=3
stopsignal=SIGTERM
priority=15

# ============================================
# Laravel Schedule Runner (Cron replacement)
# Runs every minute like cron
# ============================================

[program:schedule]
process_name=%(program_name)s
command=bash -c "while [ true ]; do php /var/www/nextmedya/artisan schedule:run --verbose --no-interaction & sleep 60; done"
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/log/schedule.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopsignal=SIGTERM
priority=30
